# 背景
有一个套餐功能，包含若干套餐计费项，例如有一个套餐包含文件签署和实名认证两个计费项，每个计费项的容量都是1000，也就是说这个套餐允许发起1000份文件和允许其下进行1000次的企业或人员认证。
每个计费项有对应的扣费规则和扣费时机，其中对于实名认证的扣费规则如下：
人员认证完成时，系统会创建一条流水记录并标记为未扣费状态，待到这个人实际进行签署动作时，，会先去数据库里检查签署方是否有实名认证计费项处于未扣费状态的记录，如果有则进行扣费。

# 问题
系统中有批量功能，可以一次性发起和签署多份合同。在进行批量场景时，会出现一个重复扣费的问题。例如，用户实名认证完成，被标记为未扣费状态，然后进行批量发起和批量签署，
那么系统会利用多线程，并发的进行合同。在签署时会先查库再决定是否更新，而多线程会带来并发问题，导致多个线程同时查发现计费项处于未扣费状态，然后都进行扣费，导致重复扣费问题。

# 实现
扣费流程如下：
1、扣费预校验：包括参数正确性，是否需要扣费，是否开启透支功能等等
2、查询未扣费记录，然后进行扣费
3、扣费后处理：更新记录状态、流水日志等等

认证包括企业认证和个人认证，因此将预校验、查询记录、后处理提取到公共父类里，而不同认证的扣费规则则抽象出模板方法，由子类实现。

# 处理
对于多线程造成的重复扣费，本质就是同时查库导致的，第一就是需要做串行化处理。
第二是由于隔离级别为RR，导致一个线程管理的事务提交了，对于另外一个线程来说也是不可见的
